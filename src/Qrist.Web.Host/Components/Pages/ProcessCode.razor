@page "/Todoist/ProcessCode"
@using System.Threading
@using Microsoft.Extensions.Logging
@using Qrist.Adapters.Todoist.Authorisation
@inject ITodoistAuthoriser TodoistAuthoriser
@inject NavigationManager NavigationManager
@inject ILogger<ProcessCode> Logger

<PageTitle>Qrist</PageTitle>

@code {

    [Parameter, SupplyParameterFromQuery]
    public string Code { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var url =
                await
                    TodoistAuthoriser
                        .GetRedirectUrlAsync(Code, CancellationToken.None);

            if (string.IsNullOrEmpty(url))
                throw new Exception("URL not available. Please try again later.");

            NavigationManager
                .NavigateTo(url);
        }
        catch (NavigationException)
        {
            throw;
        }
        catch (Exception ex)
        {
            Logger
                .LogError("ProcessCode.razor error: {message}", ex.Message);

            NavigationManager
                .NavigateTo($"/Error");
        }
    }
}